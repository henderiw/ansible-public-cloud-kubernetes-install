---
- name: create serviceaccount
  shell: kubectl create sa --namespace kube-system tiller
  register: result
  changed_when: "'created' in result.stdout"
  failed_when: "result.rc != 0 and 'already exists' not in result.stderr"

- name: create clusterrolebinding
  shell: kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller
  register: result
  changed_when: "'created' in result.stdout"
  failed_when: "result.rc != 0 and 'already exists' not in result.stderr"

- name: "generate helm.json file"
  template:
      src: helm.json.j2 
      dest: "{{ helm_bin_dir }}/helm.json"
      mode: '0644'

- name: install tiller
  shell: kubectl apply -f {{ helm_bin_dir }}/helm.json

# - name: install or upgrade tiller
#   shell: "{{ helm_bin_dir }}/helm init {{ helm_refresh_cache }} --upgrade"

- name: check serviceaccount field in {{ helm_tiller }} deployment
  shell: kubectl get deploy {{ helm_tiller }} -n kube-system -o yaml
  register: result
  changed_when: False

- name: update field of {{ helm_tiller }} deployment
  shell: kubectl patch deploy {{ helm_tiller }} -n kube-system -p '{"spec":{"template":{"spec":{"serviceAccount":"tiller"}}}}'
  register: result
  when: "'serviceAccount: tiller' not in result.stdout"